<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EcoBici • Rutas (base funcional)</title>

  <!-- Leaflet + LRM -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">

  <style>
    html, body { height:100%; margin:0; }
    #map { height: 90vh; width: 100%; }
    .ui {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 6px 8px; background:#fff; border:1px solid #ddd; border-radius:8px;
      position: fixed; z-index: 9999; top: 10px; left: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.08);
    }
    .ui button { padding:6px 10px; border:1px solid #ddd; border-radius:6px; background:#fff; cursor:pointer; margin:2px; }
    .ui button.green { background:#28a745; color:#fff; border-color:#28a745; }
    .ui button.green:hover { background:#218838; border-color:#218838; }
    .ui small { color:#666; display:block; margin-top:4px; }
  </style>
</head>
<body>

<div class="ui">
  <div><b>Rutas Leaflet</b></div>
  <button id="pick" class="green">Seleccionar (Origen → Destino)</button>
  <button id="clear">Limpiar</button>
  <button id="swap">Invertir</button>
  <button id="myloc">Usar mi ubicación</button>
    <button type="button" class="btn btn-secondary btn-submit" onclick="window.history.back();">Volver</button>
  <small>Distancia: <span id="dist">—</span> · Tiempo: <span id="time">—</span></small>
  <small>Tip: clic izq. para origen/destino · clic derecho para intermedio · “Usar mi ubicación” solo indica</small>
</div>

<div id="map"></div>

<!-- JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

<script>
(function(){
  // ===== Mapa base
  const CENTER = [15.726, -88.605]; // Puerto Barrios
  const map = L.map('map').setView(CENTER, 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  window.addEventListener('load', () => setTimeout(() => map.invalidateSize(), 100));

  // ===== Routing (OSRM demo público)
  const router = L.Routing.osrmv1({
    serviceUrl: 'https://router.project-osrm.org/route/v1',
    profile: 'car' // demo; para bici real -> backend propio
  });

  const routing = L.Routing.control({
    router,
    waypoints: [],
    routeWhileDragging: true,
    draggableWaypoints: true,
    addWaypoints: true,
    show: false,
    lineOptions: { styles: [{ color: '#28a745', weight: 5, opacity: 0.9 }] },
    createMarker: (i, wp, n) => L.marker(wp.latLng, {draggable:true})
      .bindTooltip(i===0?'Origen':(i===n-1?'Destino':'Intermedio'))
  }).addTo(map);

  // ===== UI refs
  const distEl = document.getElementById('dist');
  const timeEl = document.getElementById('time');
  const btnPick = document.getElementById('pick');
  const btnClear = document.getElementById('clear');
  const btnSwap  = document.getElementById('swap');
  const btnMyLoc = document.getElementById('myloc');

  let picking = false, clicks = 0;

  // ===== Selección Origen/Destino (clic izquierdo)
  btnPick.addEventListener('click', () => { picking = true; clicks = 0; alert('Clic en el mapa: Origen y luego Destino'); });
  map.on('click', (e) => {
    if (!picking) return;
    const wps = routing.getWaypoints();
    if (clicks === 0) {
      wps[0] = new L.Routing.Waypoint(e.latlng);
      routing.setWaypoints(wps);
      clicks = 1;
    } else {
      wps[1] = new L.Routing.Waypoint(e.latlng);
      routing.setWaypoints(wps);
      picking = false;
      clicks = 0;
    }
  });

  // ===== Punto intermedio (clic derecho)
  map.on('contextmenu', (e) => {
    const current = routing.getWaypoints().filter(w => w.latLng);
    if (current.length < 2) { alert('Primero define origen y destino.'); return; }
    const wps = routing.getWaypoints();
    const insertIndex = Math.max(1, wps.length - 1); // antes del destino
    wps.splice(insertIndex, 0, new L.Routing.Waypoint(e.latlng));
    routing.setWaypoints(wps);
  });

  // ===== Limpiar
  btnClear.addEventListener('click', () => {
    routing.setWaypoints([]);
    distEl.textContent = '—';
    timeEl.textContent = '—';
  });

  // ===== Invertir
  btnSwap.addEventListener('click', () => {
    const wps = routing.getWaypoints().filter(w => w.latLng);
    if (wps.length >= 2) {
      routing.setWaypoints([wps[wps.length-1], ...wps.slice(1,-1), wps[0]]);
    } else {
      alert('Define origen y destino primero.');
    }
  });

  // ===== Usar mi ubicación (SOLO indicar, NO fija origen/destino)
  let myMarker = null, myCircle = null;
  btnMyLoc.addEventListener('click', () => {
    if (!navigator.geolocation) { alert('Geolocalización no soportada.'); return; }
    navigator.geolocation.getCurrentPosition(
      pos => {
        const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
        const acc = pos.coords.accuracy || 30;

        // centrar mapa
        map.setView(latlng, 15);

        // marcador azul (referencia) + círculo de precisión
        if (!myMarker) {
          myMarker = L.circleMarker(latlng, { radius: 8, color:'#1e90ff', fillColor:'#1e90ff', fillOpacity:0.9 })
            .addTo(map).bindPopup('Tu ubicación (referencia)');
        } else {
          myMarker.setLatLng(latlng);
        }
        if (!myCircle) {
          myCircle = L.circle(latlng, { radius: acc, color:'#1e90ff', fillColor:'#1e90ff', fillOpacity:0.1, weight:1 }).addTo(map);
        } else {
          myCircle.setLatLng(latlng); myCircle.setRadius(acc);
        }
        // NO tocamos routing.setWaypoints(): es solo referencia visual
      },
      err => alert('No se pudo obtener la ubicación.')
    );
  });

  // ===== Métricas
  routing.on('routesfound', (e) => {
    const r = e.routes[0];
    distEl.textContent = (r.summary.totalDistance/1000).toFixed(2) + ' km';
    timeEl.textContent = Math.round(r.summary.totalTime/60) + ' min';
  });
})();
</script>
</body>
</html>